name: Build Beeconmini SEED AC2 (merged steps)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 1. 检出自己仓库（含补丁）
      - name: Checkout self
        uses: actions/checkout@v4
        with:
          path: self

      # 2. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache clang cmake cpio curl file flex gawk gettext git \
            gperf libncurses5-dev libssl-dev python3 rsync unzip wget \
            zlib1g-dev zstd lib32gcc-s1 libc6-dev-i386 subversion patch

      # 3. 克隆 + feeds （3+4 合并）
      - name: Clone & feeds
        run: |
          git clone --depth=1 https://github.com/hanwckf/immortalwrt-mt798x.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 4. 复制 defconfig + 打补丁 + make defconfig （5+6+7 合并）
      - name: Config & extra options
        run: |
          cd openwrt
          cp -f defconfig/mt7981-ax3000.config .config
          # 追加自定义配置
          cat ../beeconmini-seed-ac2-extra.config  >> .config
          make defconfig

      # 5. 下载 + 编译 （8+9 合并）
      - name: Download & compile
        run: |
          cd openwrt
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s

      # 6、收集固件路径
      - name: Collect firmware
        run: |
          mkdir -p /tmp/artifacts
          find openwrt/bin/targets -type f \
            \( -name "*sysupgrade*.bin" -o -name "*factory*.bin" -o -name "*.manifest" \) \
            -exec cp {} /tmp/artifacts/ \;

      # 7、上传到 Actions Artifact（调试/备份）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: beeconmini-seed-ac2-${{ github.run_number }}
          path: /tmp/artifacts/

      # 8、生成 yyyymmdd+run_number
      - name: Generate tag
        id: tag
        run: echo "TAG=$(date +%Y%m%d)${{ github.run_number }}" >> $GITHUB_OUTPUT

      # 9、发布 Release（三合一）
      - name: Release firmware
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: ${{ steps.tag.outputs.TAG }}
          name: "Beecon Mini SEED AC2 build ${{ steps.tag.outputs.TAG }}"
          body: |
            Auto-built from ${{ github.sha }}
          files: |
            openwrt/bin/targets/*/*/*sysupgrade*
            openwrt/bin/targets/*/*/*factory*
            openwrt/bin/targets/*/*.manifest
          make_latest: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
