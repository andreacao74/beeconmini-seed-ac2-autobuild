name: Build Beeconmini SEED AC2
on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"

# ↓↓↓ 新增这一整块
permissions:
  contents: write   # 必须给写权限才能建 release
  actions: read
  checks: read
  deployments: read
  issues: read
  packages: read
  pull-requests: read
  repository-projects: read
  security-events: read
  statuses: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ 必须先 checkout，才能拿到 patches/ 和 .config
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git python3-dev libncurses5-dev libssl-dev \
            zlib1g-dev gawk flex bison gettext wget unzip rsync

      - name: Clone immortalwrt-mt798x
        run: |
          git clone --depth=1 https://github.com/hanwckf/immortalwrt-mt798x.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 3️⃣ 复制配置
      - name: Copy defconfig
        run: |
          # 先用官方 defconfig
          cp defconfig/mt7981-ax3000.config .config
          # 再叠加 patch（相当于追加/覆盖）
          patch .config < cp beeconmini-seed-ac2.config
          # 自动补全依赖
          make defconfig

      # 4️⃣ 编译
      - name: Compile
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s

      # 5️⃣ 上传固件
      - name: Collect sysupgrade images
        run: |
          mkdir /tmp/sysupgrade
          find openwrt/bin/targets -type f -name "*sysupgrade*" -exec cp {} /tmp/sysupgrade/ \;
      
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: beeconmini-seed-ac2-${{ github.run_number }}
          path: /tmp/sysupgrade/
      
      # 👇 先添加一个步骤获取当前日期
      - name: Get current date
        id: date
        run: echo "build_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # 5️⃣ 创建/更新 Release 并上传固件
      - name: Release firmware
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: build-${{ github.run_number }}
          name: "beeconmini seed ac2 编译日期：${{ steps.date.outputs.build_date }}"
          body: |
            Auto-built from commit ${{ github.sha }}
          files: |
            openwrt/bin/targets/*/*/*sysupgrade*
          make_latest: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}