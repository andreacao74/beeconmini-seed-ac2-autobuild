name: Build SEED AC2 ImmortalWrt

on:
  # 允许手动触发
  workflow_dispatch:
  # 每天北京时间 03:00（UTC 19:00）自动编译
  schedule:
    - cron: "0 19 * * *"   # 对应北京+8 

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取你的仓库（含 defconfig）
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2. 安装编译依赖
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk \
            gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev \
            python3-dev rsync unzip zlib1g-dev file wget

      # 3. 克隆 ImmortalWrt 源码
      - name: Clone ImmortalWrt
        run: |
          git clone --depth=1 https://github.com/immortalwrt/immortalwrt.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply local patch
        run: |
          cd openwrt
          patch -p1 < $GITHUB_WORKSPACE/patches/0001-rename-device-title.patch
          
      # 4. 放入你的精简配置
      - name: Copy defconfig
        run: cp $GITHUB_WORKSPACE/seed-ac2-mini.config openwrt/.config

      # 5. 预下载 dl 包（缓存加速）
      - name: Cache DL
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: ${{ runner.os }}-dl-${{ hashFiles('**/seed-ac2-mini.config') }}
          restore-keys: |
            ${{ runner.os }}-dl-

      # 6. 编译
      - name: Compile
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) download
          make -j$(nproc) || make -j1 V=s
          # 打印最终固件目录
          find bin/targets -type f -name '*sysupgrade*' | head
          
      # 7. 上传固件
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: immortalwrt-seed-ac2-${{ github.run_number }}
          path: |
            openwrt/bin/targets/mediatek/filogic/*sysupgrade*
            openwrt/bin/targets/mediatek/filogic/*factory*
            openwrt/bin/targets/mediatek/filogic/*rootfs*
            openwrt/bin/targets/mediatek/filogic/*kernel*
