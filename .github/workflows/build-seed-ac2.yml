name: Build Beeconmini SEED AC2

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"

permissions:
  contents: write
  actions: read

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      # 0. 把构建目录挂到 150 GB 临时盘
      - name: Mount free disk
        run: |
          sudo mkdir -p /mnt/openwrt
          sudo chown runner:runner /mnt/openwrt
          echo "WORKSPACE=/mnt/openwrt" >> $GITHUB_ENV

      # 1. 检出自己仓库（含补丁）
      - name: Checkout self
        uses: actions/checkout@v4
        with:
          path: source

      # 2. 释放 runner 自带空间（可选但强烈建议）
      - name: Free disk space
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache /usr/local/lib/android || true

      # 3. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ccache clang cmake cpio curl file flex gawk gettext git \
            gperf libncurses5-dev libssl-dev python3 rsync unzip wget \
            zlib1g-dev zstd lib32gcc-s1 libc6-dev-i386 subversion patch

      # 4. 克隆 + feeds（目录改到 /mnt/openwrt）
      - name: Clone & feeds
        run: |
          cd $WORKSPACE
          git clone --depth=1 https://github.com/hanwckf/immortalwrt-mt798x.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 复制 defconfig + 打补丁 + make defconfig
      - name: Config & extra options
        run: |
          cd $WORKSPACE/openwrt
          cp -f defconfig/mt7981-ax3000.config .config
          cat $GITHUB_WORKSPACE/source/beeconmini-seed-ac2-extra.config >> .config
          make defconfig

      # 6. 下载 + 编译
      - name: Download & compile
        run: |
          cd $WORKSPACE/openwrt
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s

      # 7. 收集固件
      - name: Collect firmware
        run: |
          mkdir -p /tmp/artifacts
          find $WORKSPACE/openwrt/bin/targets -type f \
            \( -name "*sysupgrade*.bin" -o -name "*factory*.bin" -o -name "*.manifest" \) \
            -exec cp {} /tmp/artifacts/ \;

      # 8. 上传 Artifact
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: beeconmini-seed-ac2-${{ github.run_number }}
          path: /tmp/artifacts/

      # 9、生成 yyyymmdd+run_number
      - name: Generate tag
        id: tag
        run: echo "TAG=$(date +%Y%m%d)${{ github.run_number }}" >> $GITHUB_OUTPUT

      # 10、发布 Release（三合一）
      - name: Release firmware
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: ${{ steps.tag.outputs.TAG }}
          name: "Beecon Mini SEED AC2 build ${{ steps.tag.outputs.TAG }}"
          body: |
            Auto-built from ${{ github.sha }}
          files: |
            openwrt/bin/targets/*/*/*sysupgrade*
            openwrt/bin/targets/*/*/*factory*
            openwrt/bin/targets/*/*.manifest
          make_latest: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
