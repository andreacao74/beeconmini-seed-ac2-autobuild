name: Build Beeconmini SEED AC2
on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"

# â†“â†“â†“ æ–°å¢è¿™ä¸€æ•´å—
permissions:
  contents: write   # å¿…é¡»ç»™å†™æƒé™æ‰èƒ½å»º release
  actions: read
  checks: read
  deployments: read
  issues: read
  packages: read
  pull-requests: read
  repository-projects: read
  security-events: read
  statuses: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ å¿…é¡»å…ˆ checkoutï¼Œæ‰èƒ½æ‹¿åˆ° patches/ å’Œ .config
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git python3-dev libncurses5-dev libssl-dev \
            zlib1g-dev gawk flex bison gettext wget unzip rsync

      - name: Clone immortalwrt-mt798x
        run: |
          git clone --depth=1 https://github.com/hanwckf/immortalwrt-mt798x.git openwrt
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 3ï¸âƒ£ å¤åˆ¶é…ç½®
      - name: Copy defconfig
        run: |
          # å…ˆç”¨å®˜æ–¹ defconfig
          cp defconfig/mt7981-ax3000.config .config
          # å†å åŠ  patchï¼ˆç›¸å½“äºè¿½åŠ /è¦†ç›–ï¼‰
          patch .config < cp beeconmini-seed-ac2.config
          # è‡ªåŠ¨è¡¥å…¨ä¾èµ–
          make defconfig

      # 4ï¸âƒ£ ç¼–è¯‘
      - name: Compile
        run: |
          cd openwrt
          make defconfig
          make download -j$(nproc)
          make -j$(nproc) || make -j1 V=s

      # 5ï¸âƒ£ ä¸Šä¼ å›ºä»¶
      - name: Collect sysupgrade images
        run: |
          mkdir /tmp/sysupgrade
          find openwrt/bin/targets -type f -name "*sysupgrade*" -exec cp {} /tmp/sysupgrade/ \;
      
      - name: Upload firmware
        uses: actions/upload-artifact@v4
        with:
          name: beeconmini-seed-ac2-${{ github.run_number }}
          path: /tmp/sysupgrade/
      
      # ğŸ‘‡ å…ˆæ·»åŠ ä¸€ä¸ªæ­¥éª¤è·å–å½“å‰æ—¥æœŸ
      - name: Get current date
        id: date
        run: echo "build_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # 5ï¸âƒ£ åˆ›å»º/æ›´æ–° Release å¹¶ä¸Šä¼ å›ºä»¶
      - name: Release firmware
        uses: softprops/action-gh-release@v2
        if: success()
        with:
          tag_name: build-${{ github.run_number }}
          name: "beeconmini seed ac2 ç¼–è¯‘æ—¥æœŸï¼š${{ steps.date.outputs.build_date }}"
          body: |
            Auto-built from commit ${{ github.sha }}
          files: |
            openwrt/bin/targets/*/*/*sysupgrade*
          make_latest: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}